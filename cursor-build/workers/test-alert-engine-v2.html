<!DOCTYPE html>
<html>
<head>
    <title>CryptoGuard AlertEngine v2.1 - Real-time Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #0f0f0f; color: #fff; }
        .container { max-width: 1200px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .card { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 15px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background: #1a472a; border: 1px solid #28a745; }
        .error { background: #472a1a; border: 1px solid #dc3545; }
        .alert { background: #47361a; border: 1px solid #ffc107; }
        .data { background: #1a3447; border: 1px solid #17a2b8; }
        .info { background: #2a2a47; border: 1px solid #6f42c1; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        .messages { height: 300px; overflow-y: auto; background: #2a2a2a; padding: 10px; border-radius: 5px; border: 1px solid #444; }
        .message { margin: 5px 0; padding: 5px; border-radius: 3px; font-size: 12px; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #444; background: #333; color: #fff; border-radius: 3px; width: 150px; }
        .crypto-display { font-size: 18px; line-height: 1.6; }
        .price { font-size: 24px; font-weight: bold; color: #28a745; }
        .change-positive { color: #28a745; }
        .change-negative { color: #dc3545; }
        .sentiment { padding: 5px 10px; border-radius: 15px; font-weight: bold; }
        .sentiment-bullish { background: #28a745; }
        .sentiment-neutral { background: #6c757d; }
        .sentiment-bearish { background: #dc3545; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0; }
        .stat-item { text-align: center; padding: 10px; background: #2a2a2a; border-radius: 5px; }
        .stat-value { font-size: 20px; font-weight: bold; color: #17a2b8; }
        .stat-label { font-size: 12px; color: #888; }
        h1, h2, h3 { color: #fff; }
        .highlight { background: #3a3a3a; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ CryptoGuard AlertEngine v2.1 - Real-time Test</h1>
        
        <div id="connectionStatus" class="status">Disconnected</div>
        
        <div>
            <button onclick="connect()" class="success">Connect to AlertEngine</button>
            <button onclick="disconnect()" class="danger">Disconnect</button>
            <button onclick="getStatus()">Get Status</button>
            <button onclick="forceUpdate()">Force Update</button>
            <button onclick="ping()">Ping</button>
        </div>

        <div class="grid">
            <!-- Bitcoin Card -->
            <div class="card">
                <h3>üü† Bitcoin (BTC)</h3>
                <div id="btcDisplay" class="crypto-display">
                    <div class="price" id="btcPrice">Loading...</div>
                    <div id="btcChange">-</div>
                    <div>Sentiment: <span id="btcSentiment" class="sentiment">-</span></div>
                    <div>Volume: <span id="btcVolume">-</span></div>
                    <div>Interactions: <span id="btcInteractions">-</span></div>
                </div>
            </div>

            <!-- Ethereum Card -->
            <div class="card">
                <h3>üî∑ Ethereum (ETH)</h3>
                <div id="ethDisplay" class="crypto-display">
                    <div class="price" id="ethPrice">Loading...</div>
                    <div id="ethChange">-</div>
                    <div>Sentiment: <span id="ethSentiment" class="sentiment">-</span></div>
                    <div>Volume: <span id="ethVolume">-</span></div>
                    <div>Interactions: <span id="ethInteractions">-</span></div>
                </div>
            </div>
        </div>

        <!-- Market Summary -->
        <div class="card">
            <h3>üìä Market Summary</h3>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalMarketCap">-</div>
                    <div class="stat-label">Total Market Cap</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="btcDominance">-</div>
                    <div class="stat-label">BTC Dominance</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="fearGreedIndex">-</div>
                    <div class="stat-label">Fear & Greed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="lastUpdate">-</div>
                    <div class="stat-label">Last Update</div>
                </div>
            </div>
        </div>
        
        <!-- Custom Alerts -->
        <div class="card">
            <h3>üîî Set Custom Alert</h3>
            <div>
                Symbol: <select id="alertSymbol">
                    <option value="bitcoin">Bitcoin</option>
                    <option value="ethereum">Ethereum</option>
                </select>
                Type: <select id="alertType">
                    <option value="price_above">Price Above</option>
                    <option value="price_below">Price Below</option>
                    <option value="sentiment_spike">Sentiment Spike</option>
                </select>
                Threshold: <input type="number" id="alertThreshold" value="125000" placeholder="Threshold">
                <button onclick="setAlert()">Set Alert</button>
            </div>
        </div>

        <!-- Subscriptions -->
        <div class="card">
            <h3>üì° Subscriptions</h3>
            <button onclick="subscribe('bitcoin')">Subscribe Bitcoin</button>
            <button onclick="subscribe('ethereum')">Subscribe Ethereum</button>
            <button onclick="unsubscribe('bitcoin')" class="danger">Unsubscribe Bitcoin</button>
            <button onclick="unsubscribe('ethereum')" class="danger">Unsubscribe Ethereum</button>
        </div>
        
        <!-- Live Messages -->
        <div class="card">
            <h3>üì∫ Live Messages <span id="messageCount" class="highlight">0</span></h3>
            <div id="messages" class="messages"></div>
        </div>
    </div>

    <script>
        let socket = null;
        let messageCount = 0;
        let connectionId = null;

        function connect() {
            const wsUrl = 'wss://cryptoguard-api.cryptoguard-api.workers.dev/alerts';
            
            try {
                socket = new WebSocket(wsUrl);
                
                socket.onopen = function(event) {
                    updateStatus('Connected to AlertEngine v2.1!', 'connected');
                    addMessage('‚úÖ Connected to AlertEngine v2.1 - Real-time monitoring active', 'connected');
                };
                
                socket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleMessage(data);
                };
                
                socket.onclose = function(event) {
                    updateStatus('Disconnected', 'error');
                    addMessage('‚ùå Disconnected from AlertEngine', 'error');
                    socket = null;
                    connectionId = null;
                };
                
                socket.onerror = function(error) {
                    updateStatus('Connection Error', 'error');
                    addMessage('üí• Connection Error: ' + error, 'error');
                };
                
            } catch (error) {
                updateStatus('Failed to connect', 'error');
                addMessage('üí• Failed to connect: ' + error, 'error');
            }
        }

        function disconnect() {
            if (socket) {
                socket.close();
            }
        }

        function ping() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'ping' }));
                addMessage('üì° Ping sent', 'data');
            }
        }

        function getStatus() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'get_status' }));
                addMessage('üìä Status request sent', 'data');
            }
        }

        function forceUpdate() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'force_update' }));
                addMessage('üîÑ Force update triggered', 'info');
            }
        }

        function setAlert() {
            const symbol = document.getElementById('alertSymbol').value;
            const alertType = document.getElementById('alertType').value;
            const threshold = parseFloat(document.getElementById('alertThreshold').value);
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'set_alert',
                    symbol: symbol,
                    alertType: alertType,
                    threshold: threshold
                }));
                addMessage(`üîî Alert set: ${symbol} ${alertType} ${threshold}`, 'alert');
            }
        }

        function subscribe(symbol) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'subscribe', symbol: symbol }));
                addMessage(`‚ûï Subscribed to ${symbol}`, 'data');
            }
        }

        function unsubscribe(symbol) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ type: 'unsubscribe', symbol: symbol }));
                addMessage(`‚ûñ Unsubscribed from ${symbol}`, 'data');
            }
        }

        function handleMessage(data) {
            messageCount++;
            document.getElementById('messageCount').textContent = messageCount;
            
            let messageClass = 'data';
            let prefix = 'üì®';
            
            switch(data.type) {
                case 'connected':
                    prefix = 'üîó';
                    messageClass = 'connected';
                    connectionId = data.sessionId;
                    if (data.currentData) {
                        updateCryptoDisplay(data.currentData);
                    }
                    break;
                    
                case 'realtime_update':
                    prefix = 'üîÑ';
                    messageClass = 'data';
                    updateCryptoDisplay(data.data);
                    updateMarketSummary(data.market_summary);
                    updateLastUpdate();
                    // Don't log every update to avoid spam
                    return;
                    
                case 'data_snapshot':
                    prefix = 'üìä';
                    messageClass = 'data';
                    updateCryptoDisplay(data.data);
                    break;
                    
                case 'default_alert':
                case 'custom_alert_triggered':
                    prefix = data.alert.emoji || 'üö®';
                    messageClass = 'alert';
                    showAlert(data);
                    break;
                    
                case 'pong':
                    prefix = 'üèì';
                    addMessage(`${prefix} Pong received - Auto-broadcast: ${data.auto_broadcast}`, 'info');
                    return;
                    
                case 'error':
                    prefix = '‚ùå';
                    messageClass = 'error';
                    break;
                    
                case 'alert_created':
                    prefix = 'üîî';
                    messageClass = 'alert';
                    break;
                    
                case 'status_update':
                    prefix = 'üìà';
                    messageClass = 'info';
                    showStatusUpdate(data);
                    break;
            }
            
            addMessage(`${prefix} ${data.type}: ${data.message || JSON.stringify(data, null, 2)}`, messageClass);
        }

        function updateCryptoDisplay(data) {
            // Update Bitcoin
            if (data.bitcoin) {
                const btc = data.bitcoin;
                document.getElementById('btcPrice').textContent = btc.price_formatted || `$${btc.price.toLocaleString()}`;
                
                const changeEl = document.getElementById('btcChange');
                changeEl.textContent = `${btc.change_24h > 0 ? '+' : ''}${btc.change_24h.toFixed(2)}%`;
                changeEl.className = btc.change_24h > 0 ? 'change-positive' : 'change-negative';
                
                updateSentiment('btcSentiment', btc.sentiment);
                document.getElementById('btcVolume').textContent = btc.volume_formatted || formatVolume(btc.volume);
                document.getElementById('btcInteractions').textContent = `${(btc.interactions_24h / 1000000).toFixed(1)}M`;
            }
            
            // Update Ethereum
            if (data.ethereum) {
                const eth = data.ethereum;
                document.getElementById('ethPrice').textContent = eth.price_formatted || `$${eth.price.toLocaleString()}`;
                
                const changeEl = document.getElementById('ethChange');
                changeEl.textContent = `${eth.change_24h > 0 ? '+' : ''}${eth.change_24h.toFixed(2)}%`;
                changeEl.className = eth.change_24h > 0 ? 'change-positive' : 'change-negative';
                
                updateSentiment('ethSentiment', eth.sentiment);
                document.getElementById('ethVolume').textContent = eth.volume_formatted || formatVolume(eth.volume);
                document.getElementById('ethInteractions').textContent = `${(eth.interactions_24h / 1000000).toFixed(1)}M`;
            }
        }

        function updateSentiment(elementId, sentiment) {
            const el = document.getElementById(elementId);
            el.textContent = `${sentiment.toFixed(0)}%`;
            
            if (sentiment >= 70) {
                el.className = 'sentiment sentiment-bullish';
            } else if (sentiment >= 40) {
                el.className = 'sentiment sentiment-neutral';
            } else {
                el.className = 'sentiment sentiment-bearish';
            }
        }

        function updateMarketSummary(summary) {
            if (summary) {
                document.getElementById('totalMarketCap').textContent = formatVolume(summary.total_market_cap);
                document.getElementById('btcDominance').textContent = `${summary.btc_dominance.toFixed(1)}%`;
                document.getElementById('fearGreedIndex').textContent = `${summary.fear_greed_index.toFixed(0)}`;
            }
        }

        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        function formatVolume(volume) {
            const num = parseFloat(volume || 0);
            if (num >= 1e12) return `$${(num / 1e12).toFixed(2)}T`;
            if (num >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
            if (num >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
            if (num >= 1e3) return `$${(num / 1e3).toFixed(2)}K`;
            return `$${num.toFixed(2)}`;
        }

        function showAlert(data) {
            // Flash the browser tab
            const originalTitle = document.title;
            document.title = `üö® ALERT! ${data.alert.symbol?.toUpperCase() || 'CRYPTO'}`;
            setTimeout(() => { document.title = originalTitle; }, 5000);
            
            // Show browser notification if supported
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(`CryptoGuard Alert`, {
                    body: data.message || data.alert.message,
                    icon: '/favicon.ico'
                });
            }
        }

        function showStatusUpdate(data) {
            addMessage(`üìä Status: ${data.activeAlerts} alerts, Auto-broadcast: ${data.autoBroadcast}, Next: ${data.nextBroadcast ? new Date(data.nextBroadcast).toLocaleTimeString() : 'N/A'}`, 'info');
        }

        function updateStatus(message, className) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.textContent = message;
            statusEl.className = 'status ' + className;
        }

        function addMessage(message, className) {
            const messagesEl = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message ' + className;
            messageEl.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
            
            // Keep only last 100 messages
            while (messagesEl.children.length > 100) {
                messagesEl.removeChild(messagesEl.firstChild);
            }
        }

        // Request notification permission on load
        window.onload = function() {
            addMessage('üîß AlertEngine v2.1 Test Page Loaded', 'data');
            addMessage('üì° Click "Connect to AlertEngine" to start real-time monitoring', 'data');
            
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        };
    </script>
</body>
</html>
